<!DOCTYPE html>
<html>
  <head>
    <script>
      performance.mark("code/didStartRenderer");
    </script>
    <meta charset="utf-8" />

    <!-- Mobile tweaks -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Code" />
    <link rel="apple-touch-icon" href="https://raw.esm.sh/code-oss@1.105.1/code-192.png" />

    <!-- Disable pinch zooming -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
    />

    <!-- Workbench Icon/Manifest/CSS -->
    <link rel="icon" href="https://raw.esm.sh/code-oss@1.105.1/favicon.ico" type="image/x-icon" />
  </head>

  <body aria-label="">
    <style>
      @import url(//raw.esm.sh/varvara-css/dist/varvara.css);

      @keyframes bg-scrolling-reverse {
        100% {
          background-position: 50px 50px;
        }
      }
      @keyframes bg-scrolling {
        0% {
          background-position: 50px 50px;
        }
      }
      :root {
        background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAIAAACRXR/mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAABnSURBVHja7M5RDYAwDEXRDgmvEocnlrQS2SwUFST9uEfBGWs9c97nbGtDcquqiKhOImLs/UpuzVzWEi1atGjRokWLFi1atGjRokWLFi1atGjRokWLFi1af7Ukz8xWp8z8AAAA//8DAJ4LoEAAlL1nAAAAAElFTkSuQmCC")
          repeat 0 0;
        animation: bg-scrolling-reverse calc(0.92s * 3) infinite;
        animation-timing-function: linear;
      }

      body {
        margin: 0;
      }

      main {
        min-height: 100vh;
        display: grid;
        place-items: center;
      }

      #form {
        max-width: 400px;
        padding: 1rem;
        margin-inline: auto;
      }

      #form label {
        margin-bottom: 8px;
      }

      footer {
        position: fixed;
        box-sizing: border-box;
        width: 100%;
        bottom: 0;
        border-top: var(--va-border-width) var(--va-border-color) dashed;
        font-size: 80%;
        padding: 2px 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      select.va-select {
        interpolate-size: allow-keywords;
        transition: width 0.2s ease, height 0.2s ease;

        &,
        &::picker(select) {
          appearance: base-select;
          border-radius: 0;
        }

        &::picker(select) {
          border: solid var(--va-border-width) var(--va-border-color);
          background-color: var(--va-background-color-default);
          transition: display 0.2s allow-discrete, overlay 0.2s allow-discrete, opacity 0.2s ease,
            transform 0.2s ease-in-out;
        }

        /* off stage */
        &:not(:open)::picker(select) {
          opacity: 0;
          transform: scale(0.95);
          transition-duration: 0.1s;
        }
        /* on stage */
        &:open::picker(select) {
          opacity: 1;
          @starting-style {
            opacity: 0.25;
          }
        }

        &::picker-icon {
          display: none;
        }

        option {
          height: calc(var(--va-button-padding) * 2 + var(--va-button-font-size));
          padding-inline: var(--va-button-padding);
          transition: background-color 0.2s ease, outline-offset 0.2s ease;
          &:focus-visible {
            outline: 2px solid rgb(from var(--va-color-primary) r g b / 0.5);
            outline-offset: -2px;
          }
          &:checked {
            background-color: var(--va-color-primary);
            &,
            &::checkmark {
              color: var(--va-background-color-default);
            }
          }
        }
      }
    </style>

    <main>
      <form id="form">
        <div class="va-card w-full">
          <div class="va-card__body">
            <h1 class="va-card__title">Login to WEDBAV</h1>

            <label for="endpoint">
              <span>endpoint</span>
              <input
                class="va-input"
                name="endpoint"
                id="endpoint"
                type="url"
                placeholder="https://wedbav.example.net"
                required
              />
            </label>

            <label for="username">
              <span>username</span>
              <input class="va-input" id="username" type="text" name="username" />
            </label>

            <label for="password">
              <span>password</span>
              <input class="va-input" id="password" type="password" name="password" />
            </label>
          </div>

          <div class="va-card__actions">
            <label for="scheme">
              <span>scheme</span>
              <select class="va-select" name="scheme" id="scheme">
                <option selected value="wedbav">wedbav</option>
                <option value="webdav">webdav</option>
              </select>
            </label>
            <input type="submit" class="va-button" value="LOGIN" style="text-align: right" />
          </div>
        </div>
      </form>
    </main>

    <footer>
      <span> <strong>wedbav-vscode</strong><span>@1.105.1</span> </span>
      <a href="https://github.com/YieldRay/wedbav-vscode" class="va-link" style="color: var(--va-color-primary)">
        Github
      </a>
    </footer>
  </body>

  <script type="module">
    const form = document.getElementById("form");

    // first, restore from localStorage
    const query = localStorage.getItem("wedbav");
    if (query) {
      const params = new URLSearchParams(query);
      for (const [key, value] of params) {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
          input.value = value;
        }
      }
    }

    // second, override from URL query parameters
    const searchParams = new URLSearchParams(location.search);
    for (const prop of ["endpoint", "username", "password"]) {
      if (searchParams.has(prop)) {
        form[prop].value = searchParams.get(prop);
      }
    }

    // finally, default endpoint to current origin
    if (!form.endpoint.value) {
      form.endpoint.value = location.origin;
    }
  </script>

  <!-- Startup (do not modify order of script tags!) -->
  <script>
    const baseUrl = new URL("https://raw.esm.sh/code-oss@1.105.1/out/", window.location.href);
    globalThis._VSCODE_FILE_ROOT = baseUrl.origin + baseUrl.pathname;
  </script>
  <script>
    performance.mark("code/willLoadWorkbenchMain");
  </script>
  <!-- always ensure built in english NLS messages -->
  <script type="module" src="https://raw.esm.sh/code-oss@1.105.1/out/nls.messages.js"></script>
  <script type="module">
    const form = document.getElementById("form");

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const sp = new URLSearchParams(new FormData(form));
      useQuery(sp);
    });

    async function useQuery(searchParams) {
      if (!searchParams.get("endpoint")) {
        alert("endpoint is required");
        return;
      }

      const url = new URL(searchParams.get("endpoint"));
      const query = searchParams.toString();
      localStorage.setItem("wedbav", query);

      // show loading
      form.innerHTML = /*html*/ `<h2 class="va-loading-dots">Loading</h2>`;

      // load workbench
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = "https://raw.esm.sh/code-oss@1.105.1/out/vs/workbench/workbench.web.main.internal.css";
      document.head.appendChild(link);

      const [{ default: init }] = await Promise.all([
        import("https://raw.esm.sh/code-oss@1.105.1/workbench.js"),
        new Promise((resolve, reject) => {
          link.onload = resolve;
          link.onerror = reject;
        }),
      ]);

      // load NLS for user's locale (with timeout fallback)
      await Promise.any([
        import(`https://raw.esm.sh/code-oss@1.105.1/nls/${navigator.language.toLowerCase()}/nls.messages.js`).catch(
          () => {}
        ),
        new Promise((resolve) => setTimeout(resolve, 5000)),
      ]);

      // clear body
      document.body.innerHTML = "";

      // init workbench
      init(document.body, {
        productConfiguration: {
          nameShort: "wedbav",
          nameLong: "wedbav",
          applicationName: "wedbav",
          dataFolderName: "",
          extensionsGallery: {
            serviceUrl: "https://open-vsx.org/vscode/gallery",
            itemUrl: "https://open-vsx.org/vscode/item",
            resourceUrlTemplate:
              "https://openvsxorg.blob.core.windows.net/resources/{publisher}/{name}/{version}/{path}",
          },
          extensionEnabledApiProposals: {},
          /** IMPORTANT CONFIG TO MAKE webWorkerExtensionHostIframe.html work */
          webEndpointUrlTemplate: "https://raw.esm.sh/code-oss@1.105.1",
          quality: "stable",
        },
        folderUri: {
          // default to wedbav
          scheme: searchParams.get("scheme") === "webdav" ? "webdav" : "wedbav",
          authority: url.host,
          query,
          path: url.pathname, // it is '/'
        },
        additionalBuiltinExtensions: [
          {
            scheme: location.protocol.replace(":", ""),
            authority: location.host,
            path: location.pathname + "extension/dist",
          },
        ],
      });
    }
  </script>
</html>
